.. _page_0:

===========================================
tmux和tmuxp的学习笔记
===========================================

01) tmux
========================

01-01) 安装tmux
----------------------

CentOS系统默认不集成tmux工具，可以添加第3方仓库http://pkgs.repoforge.org/tmux/来安装，也可能通过源代码编译安装tmux。

而debian系统的软件仓库收录了tmux，可直接用2进制软件包安装也可以用源代码编译安装。

01-01-01) CentOS系统下源码编译安装tmux-1.5：
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

tmux依赖 ``libevent`` 和 ``ncurses`` 开发包：
(在CentOS 5/6系统中的 ``libevent-devel`` 版本太低，无法满足tmux的要求，所以需要用libevent源码编译安装，安装之后，再做一个链接即可。)
``libevent-2.0.10-stable.tar.gz`` 源码编译安装

.. code-block:: bash
    :linenos:

    [root@dns1 ~]# tar xzvf libevent-2.0.10-stable-tar.gz
    [root@dns1 ~]# cd libevent-2.0.10-stable
    [root@dns1 ~]# ./configure && make && make install
    [root@dns1 ~]# ln -s  /usr/local/lib/libevent-2.0.so.5 /usr/lib/libevent-2.0.so.5

``ncurses-devel`` 可以直接使用系统２进制软件包安装

.. code-block:: bash
    :linenos:

    [root@dns1 ~]# yum install ncurses-devel
    [root@dns1 ~]# tar xzvf tmux-1.5.tar.gz
    [root@dns1 ~]# cd tmux-1.5
    [root@dns1 tmux-1.5]# configure && make && make install
    [root@dns1 tmux-1.5]# tmux ls
    tmux: error while loading shared libraries: libevent-2.0.so.5: cannot open shared object file: No such file or directory

如果出现上面的错误提示，是因为安装libevent之后忘了做链接动态库。

.. code-block:: bash
    :linenos:

    [root@dns1 tmux-1.5]# ln -s  /usr/local/lib/libevent-2.0.so.5 /usr/lib/libevent-2.0.so.5
    [root@dns1 tmux-1.5]# tmux


01-01-02) debian系统可以直接从系统软件包来安装
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash
     :linenos:

     [admin@debian ~] sudo apt-get install tmux

01-02) 基本使用
----------------------

01-02-01) tmux默认的按键绑定
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

tmux may be controlled from an attached client by using a key combination of a prefix key, ‘C-b’ (Ctrl-b) by default, followed by a command.
The default command key bindings are::

   C-b         Send the prefix key (C-b) through to the application.
   C-o         Rotate the panes in the current window forwards.
   C-z         Suspend the tmux client.
   !           Break the current pane out of the window.
   "           Split the current pane into two, top and bottom.
   #           List all paste buffers.
   %           Split the current pane into two, left and right.
   &           Kill the current window.
   ’           Prompt for a window index to select.
   ,           Rename the current window.
   -           Delete the most recently copied buffer of text.
   .           Prompt for an index to move the current window.
   0 to 9      Select windows 0 to 9.
   :           Enter the tmux command prompt.
   ;           Move to the previously active pane.
   =           Choose which buffer to paste interactively from a list.
   ?           List all key bindings.
   D           Choose a client to detach.
   [           Enter copy mode to copy text or view the history.
   ]           Paste the most recently copied buffer of text.
   c           Create a new window.
   d           Detach the current client.
   f           Prompt to search for text in open windows.
   i           Display some information about the current window.
   l           Move to the previously selected window.
   n           Change to the next window.
   o           Select the next pane in the current window.
   p           Change to the previous window.
   q           Briefly display pane indexes.
   r           Force redraw of the attached client.
   s           Select a new session for the attached client interactively.
   L           Switch the attached client back to the last session.
   t           Show the time.
   w           Choose the current window interactively.
   x           Kill the current pane.
   {           Swap the current pane with the previous pane.
   }           Swap the current pane with the next pane.
   ~           Show previous messages from tmux, if any.
   Page Up     Enter copy mode and scroll one page up.
   Up, Down
   Left, Right  Change to the pane above, below, to the left, or to the right of the current pane.
   M-1 to M-5  Arrange panes in one of the five preset layouts: even-horizontal, even-vertical, main-horizontal, main-verti-cal, or tiled.
   M-n         Move to the next window with a bell or activity marker.
   M-o         Rotate the panes in the current window backwards.
   M-p         Move to the previous window with a bell or activity marker.
   C-Up, C-Down
   C-Left, C-Right  Resize the current pane in steps of one cell.
   M-Up, M-Down
   M-Left, M-Right  Resize the current pane in steps of five cells.

Key bindings may be changed with the bind-key and unbind-key commands.
可以使用命令bind-key和unbind-key来修改按键对应的命令。

01-02-02) tmux中的一些关键词
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

根据tmux的定义，在开启了tmux服务器后，会首先创建一个会话，而这个会话则会首先创建一个窗口，其中仅包含一个面板；也就是说，这里看到的所谓终端控制台应该称作tmux的一个面板，虽然其使用方法与终端控制台完全相同。

tmux使用C/S模型构建，主要包括以下单元模块：

#. server 服务器。输入tmux命令时就开启了一个服务器。 
#. session 会话。一个服务器可以包含多个会话。 
#. window 窗口。一个会话可以包含多个窗口。
#. pane 面板。一个窗口可以包含多个面板。

操作: 类似各种平铺式窗口管理器，tmux使用键盘操作，常用快捷键包括： 
Ctrl+b  激活控制台；此时以下按键生效 

系统操作::

    ?       列出所有快捷键；按q返回
    d       脱离当前会话；这样可以暂时返回Shell界面，输入tmux attach能够重新进入之前的会话 
    D       选择要脱离的会话；在同时开启了多个会话时使用Ctrl+z 挂起当前会话
    r       强制重绘未脱离的会话
    s       选择并切换会话；在同时开启了多个会话时使用
    :       进入命令行模式；此时可以输入支持的命令，例如kill-server可以关闭服务器
    [       进入复制/卷屏模式；此时的操作与emacs/vi相同
            （在配置文件中set-option -g status-keys emacs/vi）
            按q/<ENTER>退出：q为直接退出，<ENTER>为复制标记块并退出;
            emacs: Ctrl+n/Ctrl+p/Ctrl+f/Ctrl+b移动光标，Ctrl+@开始标记（开始复制），Alt+w/Ctrl+w结束标记（复制结束）并退出复制模式; 
            vim: h/j/k/l移动光标，<SPACE>开始标记（复制开始），<ENTER>结束标记（复制结束）并退出复制模式 
    ]       进入粘贴模式（C-b ]粘贴）将一个会话中的内容复制粘贴到另一个窗口中。但是不能将会话中的内容复制到第3方程序中。只能在另一个会话中开启vim或者emacs终端下的编辑程序，然后用Ctrl-b ]进行粘贴，然后在会话中的终端下编译程序中进行保存。
    ~       列出提示信息缓存；其中包含了之前tmux返回的各种提示信息

窗口操作::

    c       创建新窗口 
    &       关闭当前窗口 
    数字键   切换至指定窗口 
    p       切换至上一窗口 
    n       切换至下一窗口 
    l       在前后两个窗口间互相切换 
    w       通过窗口列表切换窗口 
    ,       重命名当前窗口；这样便于识别 
    .       修改当前窗口编号；相当于窗口重新排序 
    f       在所有窗口中查找指定文本 

面板操作::

    ”       将当前面板平分为上下两块 
    %       将当前面板平分为左右两块 
    Ctrl+Down    缩小当前面板
    Ctrl+Up      增大当前面板
    
    x       关闭当前面板 
    !       将当前面板置于新窗口；即新建一个窗口，其中仅包含当前面板 
    Ctrl+方向键    以1个单元格为单位移动边缘以调整当前面板大小 
    Alt+方向键     以5个单元格为单位移动边缘以调整当前面板大小 
    Space       在预置的面板布局中循环切换（水平分割与垂直分割）；依次包括even-horizontal、even-vertical、main-horizontal、main-vertical、tiled 
    q       显示面板编号 
    o       在当前窗口中选择下一面板（在当前窗口的多个面板中切换）
    Up/Down/Right/Left方向键    移动光标以选择面板（在当前窗口中上下左右切换面板）
    {       向前置换当前面板 
    }       向后置换当前面板 
    Alt+o   逆时针旋转当前窗口的面板 
    Ctrl+o  顺时针旋转当前窗口的面板 

shell>tmux ls   #显示已有会话(tmux list-session)

shell>tmux attach   #连接到之前断开的会话(tmux attach-session)

shell>tmux a -t 0/1/2    #连接到之前断开的某一个会话0/1/2

shell> tmux list-session  #显示所有会话

shell> tmux list-windows   #显示所有窗口

shell> tmux list-panes  #显示所有面板

shell> tmux list-clients  #显示连接到SERVER上的客户端attached

::

  shell> tmux ls
  0: 2 windows (created Thu Jan  3 12:01:08 2013) [80x23] (attached)
  shell> tmux new-session
  shell> tmux ls
  0: 2 windows (created Thu Jan  3 12:01:08 2013) [80x23] (attached)
  1: 1 windows (created Thu Jan  3 13:25:09 2013) [80x23] (attached)


01-03) 修改tmux的默认按键C-b替换为M-](Alt-])
-----------------------------------------------

在tmux的配置文件~/.tmux.conf中添加以下行：
::

  $ cat ~/.tmux.conf
  set-option -g prefix M-]
  unbind-key ^b
  bind-key M-] send-prefix

01-04) 分离与附加面板到窗口中
--------------------------------

M-] .   #将当前面板分离到新的窗口中

M-] :break-pane    #同上，将当前面板分离到新窗口中

M-] :join-pane -s 2 -t 1   #将当前窗口附加到某个会话(-s 2)下的某个窗口(-t 1)

02) tmuxp
===============

tmux session manager in python - json, yaml, python API http://tmuxp.readthedocs.org/en/latest/
https://github.com/tony/tmuxp

02-01) install
--------------------------
::

  /mnt/sda2h/tools/git1$ git clone https://github.com/tony/tmuxp.git tmuxp
  $ cd
  $ virtualenv tmuxp
  $ source ./tmuxp/bin/activate
  $ pip install -e /mnt/sda2h/tools/git1/tmuxp/
  (tmuxp)love@d7s3:~$ pip install -e /mnt/sda2h/tools/git1/tmuxp/
  Obtaining file:///mnt/sda2h/tools/git1/tmuxp
    Running setup.py egg_info for package from file:///mnt/sda2h/tools/git1/tmuxp
      
  Downloading/unpacking kaptan>=0.5.7 (from tmuxp==0.0.42)
    Downloading kaptan-0.5.7.tar.gz
    Running setup.py egg_info for package kaptan
      
  Downloading/unpacking argcomplete (from tmuxp==0.0.42)
    Downloading argcomplete-0.6.3.tar.gz
    Running setup.py egg_info for package argcomplete
      
  Downloading/unpacking PyYAML (from kaptan>=0.5.7->tmuxp==0.0.42)
    Downloading PyYAML-3.10.tar.gz (241kB): 241kB downloaded
    Running setup.py egg_info for package PyYAML
      
  Installing collected packages: kaptan, argcomplete, tmuxp, PyYAML
    Running setup.py install for kaptan
      
      Installing kaptan script to /home/love/tmuxp/bin
    Running setup.py install for argcomplete
      
      changing mode of build/scripts-2.7/python-argcomplete-check-easy-install-script from 644 to 755
      changing mode of build/scripts-2.7/register-python-argcomplete from 644 to 755
      changing mode of build/scripts-2.7/activate-global-python-argcomplete from 644 to 755
      changing mode of /home/love/tmuxp/bin/python-argcomplete-check-easy-install-script to 755
      changing mode of /home/love/tmuxp/bin/register-python-argcomplete to 755
      changing mode of /home/love/tmuxp/bin/activate-global-python-argcomplete to 755
    Running setup.py develop for tmuxp
      
      Creating /home/love/tmuxp/lib/python2.7/site-packages/tmuxp.egg-link (link to .)
      Adding tmuxp 0.0.42 to easy-install.pth file
      Installing tmuxp script to /home/love/tmuxp/bin
      Installing tmuxp.bash script to /home/love/tmuxp/bin
      Installing tmuxp.zsh script to /home/love/tmuxp/bin
      Installing tmuxp.tcsh script to /home/love/tmuxp/bin
      
      Installed /mnt/sda2h/tools/git1/tmuxp
    Running setup.py install for PyYAML
      checking if libyaml is compilable
      gcc -pthread -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -fPIC -I/usr/include/python2.7 -c build/temp.linux-i686-2.7/check_libyaml.c -o build/temp.linux-i686-2.7/check_libyaml.o
      build/temp.linux-i686-2.7/check_libyaml.c:2:18: fatal error: yaml.h: 没有那个文件或目录
      compilation terminated.
      
      libyaml is not found or a compiler error: forcing --without-libyaml
      (if libyaml is installed correctly, you may need to
       specify the option --include-dirs or uncomment and
       modify the parameter include_dirs in setup.cfg)
      
  Successfully installed kaptan argcomplete tmuxp PyYAML
  Cleaning up...
  (tmuxp)love@d7s3:~$ 
  (tmuxp)love@d7s3:~$ pip freeze
  PyYAML==3.10
  argcomplete==0.6.3
  argparse==1.2.1
  kaptan==0.5.7
  -e git+https://github.com/tony/tmuxp.git@8499593eb2d826ec55b7333c584c6e39557f5855#egg=tmuxp-dev
  wsgiref==0.1.2


02-02) 编写yaml风格的tmuxp配置文件(tmux的会话 窗口 面板及运行的命令)
----------------------------------------------------------------------
::

  (tmuxp)love@d7s3:~$ cat .tmuxp/devc.yaml 
  session_name: devc
  windows:
  - window_name: dev
    layout: main-vertical
    shell_command_before:
      - cd ~/gitcgo/gnuc/
    panes:
      - shell_command:
          - emacs learn_c.c
      - date

02-03) tmuxp调用上面的配置文件进入工作环境
------------------------------------------------
::

  (tmuxp)$ source ./tmuxp/bin/tmuxp.bash
  (tmuxp)$ tmuxp load devc.yaml


02-04) 更多帮助见项目文档说明
----------------------------------

``tmuxp@github``
``tmuxp docs``

.. _tmuxp_github: https://github.com/tony/tmuxp 
.. _tmuxp_docs: http://tmuxp-zh.readthedocs.org/en/latest/
