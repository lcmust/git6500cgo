<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>assembly language for Intel X86 (Linux) &mdash; sphinx01 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="sphinx01 1.0 documentation" href="index.html" />
    <link rel="next" title="example of rst/这是关于rst的学习实例" href="example.html" />
    <link rel="prev" title="tmux和tmuxp的学习笔记" href="tmux_tmuxp.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="example.html" title="example of rst/这是关于rst的学习实例"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tmux_tmuxp.html" title="tmux和tmuxp的学习笔记"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">sphinx01 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="assembly-language-for-intel-x86-linux">
<h1>assembly language for Intel X86 (Linux)<a class="headerlink" href="#assembly-language-for-intel-x86-linux" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>01) 32位处理器所含寄存器：<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>4个数据寄存器EAX EBX ECX EDX:</p>
<blockquote>
<div><ol class="arabic simple">
<li>EAX 通常为累加器，用于乘除和输入输出等</li>
<li>EBX 基地址寄存器，可作为存储器指针使用</li>
<li>ECX 计数寄存器，在循环和字符串操作时，用来控制循环次数。在位操作时用cl来指明移位的位数。</li>
<li>EDX 数据寄存器，可作为默认的操作数参与运算，或者存放I/O的端口地址。</li>
</ol>
</div></blockquote>
<p>2个变址寄存器ESI EDI:</p>
<blockquote>
<div><ol class="arabic simple">
<li>ESI　存放存储单元在段内的偏移量（源）</li>
<li>EDI  存放存储单元在段内的偏移量（目的操作数）</li>
</ol>
</div></blockquote>
<p>2个指针寄存器ESP EBP:</p>
<blockquote>
<div><ol class="arabic simple">
<li>EBP 帧指针（Base Pointer）存放堆栈内存储单元的偏移量，用于直接存取堆栈中的数据</li>
<li>ESP 堆栈指针（Stack Pointer）只用于访问堆栈的栈顶</li>
</ol>
</div></blockquote>
<p>6个段寄存器 CS DS ES SS FS GS:</p>
<blockquote>
<div><ol class="arabic simple">
<li>CS 代码段的段值</li>
<li>DS 数据段的段值</li>
<li>ES 附加数据段的段值</li>
<li>SS 堆栈段的段值</li>
<li>FS 附加数据段的段值</li>
<li>GS 附加数据段的段值</li>
</ol>
</div></blockquote>
<p>前4个CS DS ES SS段寄存器在实模式下，用于内存单元的逻辑地址取值“段值：偏移量“，在保护模式下，装入寄存器的不再是段值，而是称为选择子&#8221;Selector&#8221;的值。</p>
<p>1个指令指针寄存器EIP: 存放下一条指令在代码段中的偏移量。</p>
<p>1个标志寄存器EFlags:</p>
<blockquote>
<div><p>运算结果标志位：</p>
<ol class="arabic simple">
<li>进位标志CF(Carry Flag)用来反映运算是否产生进位或借位。如果运算结果的最高位产生了一个进位或借位，那么，其值为1，否则其值为0。</li>
<li>奇偶标志PF(Parity Flag)用于反映运算结果中“1”的个数的奇偶性。如果“1”的个数为偶数，则PF的值为1，否则其值为0。利用PF可进行奇偶校验检查，或产生奇偶校验位。在数据传送过程中，为了提供传送的可靠性，如果采用奇偶校验的方法，就可使用该标志位。</li>
<li>辅助进位标志AF(Auxiliary Carry Flag)在发生下列情况时，辅助进位标志AF的值被置为1，否则其值为0：
#. 在字操作时，发生低字节向高字节进位或借位时；
#. 在字节操作时，发生低4位向高4位进位或借位时。</li>
<li>零标志ZF(Zero Flag)零标志ZF用来反映运算结果是否为0。如果运算结果为0，则其值为1，否则其值为0。在判断运算结果是否为0时，可使用此标志位。</li>
<li>符号标志SF(Sign Flag)符号标志SF用来反映运算结果的符号位，它与运算结果的最高位相同。在微机系统中，有符号数采用补码表示法，所以，SF也就反映运算结果的正负号。运算结果为正数时，SF的值为0，否则其值为1。</li>
<li>溢出标志OF(Overflow Flag)溢出标志OF用于反映有符号数加减运算所得结果是否溢出。如果运算结果超过当前运算位数所能表示的范围，则称为溢出，OF的值被置为1，否则，OF的值被清为0。</li>
</ol>
<p>对以上6个运算结果标志位，在一般编程情况下，标志位CF、ZF、SF和OF的使用频率较高，而标志位PF和AF的使用频率较低。</p>
<p>状态控制标志位：</p>
<ol class="arabic simple">
<li>追踪标志TF(Trap Flag)当追踪标志TF被置为1时，CPU进入单步执行方式，即每执行一条指令，产生一个单步中断请求。这种方式主要用于程序的调试。</li>
<li>中断允许标志IF(Interrupt-enable Flag)用来决定CPU是否响应CPU外部的可屏蔽中断发出的中断请求。但不管该标志为何值，CPU都必须响应CPU外部的不可屏蔽中断所发出的中断请求，以及CPU内部产生的中断请求。具体规定如下：
#. 当IF=1时，CPU可以响应CPU外部的可屏蔽中断发出的中断请求；
#. 当IF=0时，CPU不响应CPU外部的可屏蔽中断发出的中断请求。
CPU的指令系统中也有专门的指令来改变标志位IF的值。</li>
<li>方向标志DF(Direction Flag)用来决定在串操作指令执行时有关指针寄存器发生调整的方向。</li>
</ol>
<p>32位标志寄存器增加的标志位：</p>
<ol class="arabic simple">
<li>I/O特权标志IOPL(I/O Privilege Level)I/O特权标志用两位二进制位来表示，也称为I/O特权级字段。该字段指定了要求执行I/O指令的特权级。如果当前的特权级别在数值上小于等于IOPL的值，那么，该I/O指令可执行，否则将发生一个保护异常。</li>
<li>嵌套任务标志NT(Nested Tash)套任务标志NT用来控制中断返回指令IRET的执行。具体规定如下：
#. 当NT=0，用堆栈中保存的值恢复EFLAGS、CS和EIP，执行常规的中断返回操作；
#. 当NT=1，通过任务转换实现中断返回。</li>
<li>重启动标志RF(Restart Flag)重启动标志RF用来控制是否接受调试故障。规定：RF=0时，表示“接受”调试故障，否则拒绝之。在成功执行完一条指令后，处理机把RF置为0，当接受到一个非调试故障时，处理机就把它置为1。</li>
<li>虚拟8086方式标志VM(Virtual 8086 Mode)如果该标志的值为1，则表示处理机处于虚拟的8086方式下的工作状态，否则，处理机处于一般保护方式下的工作状态。</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id2">
<h2>02) 汇编语言函数调用时的栈与帧<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>函数调用时，先用push指令把参数压入栈，然后call指令调用函数。call指令包含将一个返回地址（即call指令的下一条指令的地址）压入堆栈的动作。
每个函数体都由如下指令开始:
|     push %ebp;
|     mov %esp %ebp;</p>
<p>即程序在执行一个函数时，首先把帧寄存器%ebp压入堆栈进行保护；然后把栈顶地址寄存器%esp中的地址值赋给帧基地址寄存器%ebp；将栈顶地址作为子函数的帧基址。帧寄存器%ebp作为子函数的栈基地址（以此地址向下偏移一定长度来作为子函数中的变量存储地址）。</p>
<p>栈是一种特殊的数据结构，遵循&#8221;先进后出&#8221;的原则，通过push操作把数据压入栈顶（栈顶地址自减形成新的栈顶），通过pop操作将栈顶数据弹出（同时栈顶地址自加形成新的栈顶），栈顶地址是从高至低的方向增长。</p>
<p>以%ebp帧基地址为基准，向上（栈底方向）是函数的返回地址、调用者传递给被调用函数的参数；向下（栈顶方向）是函数局部变量(<tt class="docutils literal"><span class="pre">sub</span>&nbsp;&nbsp;&nbsp; <span class="pre">$0x10,%esp</span></tt>) 这条命令一般紧接到上面的2条指令之后，为函数的局部变量分配地址空间)；栈中保存的%ebp地址为上一层函数调用时的EBP值，在本级函数（被调用者）返回上一层函数（调用者）时会恢复到EBP帧指针寄存器中:</p>
<div class="highlight-python"><pre> push %ebp;
 mov %esp %ebp;
 sub $0x10, %esp;

函数P调用Q时，Q的参数是放在P的帧中，且P中的下一条指令地址被压入栈中，形成P的栈帧的末尾。Q的栈帧从保存帧指针EBP的位置开始(``push %ebp; mov %esp %ebp``)，后面是Q中的变量地址空间(``sub $0x10, %esp``)。大多数信息的访问都是相对于帧指针(%ebp)的。如果函数需要返回整数或指针的话，用寄存器%eax来保存返回值。</pre>
</div>
<dl class="docutils">
<dt>指令push %ebp的行为等价于这2条指令:</dt>
<dd>subl $4, %esp       #栈顶地址减4
movl %ebp, (%esp)   #把%ebp中的数据存储到%esp栈顶地址所指向的存储空间中</dd>
<dt>而指令pop %ebp的行为等价于这2条指令:</dt>
<dd><p class="first">movl (%esp), %ebp  #把%esp栈顶地址所指存储空间中数据存储到%ebp中
addl $4, %esp      #栈顶地址加4</p>
<p>在X86平台，寄存器%eax %edx %ecx被划分为调用者保存；当函数P（调用者）调用Q（被调用者）时，Q(被调用者)可以覆盖这些寄存器的值，而不会破坏任何P所需要的数据。
寄存器%ebx %esi %edi %ebp被划分为被调用者保存，所以Q必须在使用这些寄存器之前，将这些寄存器的值保存到栈中，并在返回P之前从栈恢复到寄存器。</p>
<p>函数调用时的栈：调用参数、返回地址、EBP、被调用函数的局部变量</p>
<p class="last">一般而言：32系统，参数变量占用4字节内存</p>
</dd>
</dl>
<div class="line-block">
<div class="line">ss:[ebp+12] 第2个参数</div>
<div class="line">ss:[ebp+8] 第1个参数</div>
<div class="line">ss:[ebp+4] 返回地址</div>
<div class="line">ss:[ebp]    上一层函数的EBP值</div>
<div class="line">ss:[ebp-4] 第1个局部变量</div>
<div class="line">ss:[ebp-8] 第2个局部变量</div>
</div>
<blockquote>
<div>由于EBP中的地址总是“上一层函数调用时的EBP值”，而在每一层函数调用中，都能通过当时的EBP值向上获取返回地址、参数值，向下获取函数局部变量；如此形成递归，直至到达栈底。</div></blockquote>
</div>
<div class="section" id="asm">
<h2>03) asm编写与调试及相关工具的使用<a class="headerlink" href="#asm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="d7s3">
<h3>03-01) d7s3下汇编学习实例<a class="headerlink" href="#d7s3" title="Permalink to this headline">¶</a></h3>
<p>汇编源代码文件:</p>
<div class="highlight-python"><pre># filename: csapp/asm_hello.s
# form: http://www.ibm.com/developerworks/cn/linux/l-assembly/
# compile: as -o asm_hello.o asm_hello.s
# link: ld -s -o asm_hello asm_hello.o
# run: ./asm_hello
# date: 2013-11-18 11:02

.data
        msg : .string "Hello, world!\n"
        len = . - msg
.text
.global _start

_start:
        movl $len, %edx
        movl $msg, %ecx
        movl $1, %ebx
        movl $4, %eax
        int $0x80

        movl $0, %ebx
        movl $1, %eax
        int $0x80</pre>
</div>
<p>汇编:</p>
<div class="highlight-python"><pre>as -o target.o source.s</pre>
</div>
<p>链接(-s 为去掉符号信息  -S 为去掉全部调试信息):</p>
<div class="highlight-python"><pre>ld -s -o target target.o</pre>
</div>
<p>运行:</p>
<div class="highlight-python"><pre>./target</pre>
</div>
<p>需要调试时，首先在汇编时生成调试信息:</p>
<div class="highlight-python"><pre>as --gstabs -o target.o source.s</pre>
</div>
<p>需要调试时，链接就需要包含符号信息和调试信息:</p>
<div class="highlight-python"><pre>ld -o target target.o</pre>
</div>
</div>
<div class="section" id="gdb">
<h3>03-02) 用gdb调试<a class="headerlink" href="#gdb" title="Permalink to this headline">¶</a></h3>
<p>用gdb调试:</p>
<div class="highlight-python"><pre>gdb ./target</pre>
</div>
</div>
<div class="section" id="ddd">
<h3>03-03) 其它调试ddd<a class="headerlink" href="#ddd" title="Permalink to this headline">¶</a></h3>
<p>DDD is a graphical front-end for GDB and other command-line debuggers
sudo apt-get install ddd ddd-doc</p>
</div>
<div class="section" id="readelf2">
<h3>03-04) readelf查看2进制目标文件<a class="headerlink" href="#readelf2" title="Permalink to this headline">¶</a></h3>
<p>-d 显示目标所动态依赖的对象信息
-s 显示目标文件中的符号链接</p>
</div>
<div class="section" id="objdump-2">
<h3>03-05) objdump显示（反汇编）2进制目标文件<a class="headerlink" href="#objdump-2" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="nm2">
<h3>03-06) nm显示2进制目标文件的链接信息<a class="headerlink" href="#nm2" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="strace">
<h3>03-07) strace动态跟踪程序运行时的系统调用<a class="headerlink" href="#strace" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="step-by-step-learn-assembly-chapter4">
<h2>04) 汇编语言中的寻址方式(step by step learn assembly: chapter4)<a class="headerlink" href="#step-by-step-learn-assembly-chapter4" title="Permalink to this headline">¶</a></h2>
<p>IA32支持多种操作数格式，源数据可以以常数形式给出，或是从寄存器或存储器中读出。结果可以存放在寄存器或存储器中。各种不同的操作数被分为3种类型：1) 立即数； 2) 寄存器； 3) 存储器。</p>
<p>立即数据寻址： $0x1234  由$后跟一个整数</p>
<p>寄存器寻址： %eax 寄存器的内容</p>
<p>存储器引用： 根据计算出来的地址（有效地址）访问某个存储器位置</p>
<p>多种不同的寻址模式：</p>
<blockquote>
<div><ol class="arabic simple">
<li>立即数寻址</li>
<li>寄存器寻址</li>
<li>绝对寻址</li>
<li>间接寻址</li>
<li>基址＋偏移量寻址</li>
<li>变址寻址</li>
<li>比例基址寻址</li>
</ol>
</div></blockquote>
<p>数据传送指令： 将数据从一个位置复制到另一个位置</p>
<blockquote>
<div><ol class="arabic simple">
<li>movb 传送字节</li>
<li>movw 传送字</li>
<li>movl 传送双字</li>
<li>movsbw 将做了符号扩展的字节传送到字</li>
<li>movsbl 将做了符号扩展的字节传送到双字</li>
<li>movswl 将做了符号扩展的字传送到双字</li>
<li>movzbw 将做了零扩展的字节传送到字</li>
<li>movzbl 将做了零扩展的字节传送到双字</li>
<li>movzwl 将做了零扩展的字传送到双字</li>
<li>pushl 将双字入栈</li>
<li>popl 将双字出栈</li>
</ol>
</div></blockquote>
<p>mov类中的指令将源操作数的值复制到目的操作数中，源操作数指定的值是一个立即数，存储在寄存器中或者存储器中。目的操作数指定一个位置，要么是一个寄存器，要么是一个存储器地址。</p>
<p>IA32有一个限制性的规定：传送指令的2个操作数不能同时指向存储器位置；将一个值从一个存储器位置复制到另一个存储器位置需要2条指令：第1条指令将源值加载到寄存器中、第2条指令将该寄存器中的值写入到存储器目的位置。</p>
</div>
<div class="section" id="id3">
<h2>05)<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id4">
<h2>06)<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id5">
<h2>07)<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="linuxc">
<h2>08) 在LinuxC中嵌入汇编语言<a class="headerlink" href="#linuxc" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id6">
<h2>09)<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">assembly language for Intel X86 (Linux)</a><ul>
<li><a class="reference internal" href="#id1">01) 32位处理器所含寄存器：</a></li>
<li><a class="reference internal" href="#id2">02) 汇编语言函数调用时的栈与帧</a></li>
<li><a class="reference internal" href="#asm">03) asm编写与调试及相关工具的使用</a><ul>
<li><a class="reference internal" href="#d7s3">03-01) d7s3下汇编学习实例</a></li>
<li><a class="reference internal" href="#gdb">03-02) 用gdb调试</a></li>
<li><a class="reference internal" href="#ddd">03-03) 其它调试ddd</a></li>
<li><a class="reference internal" href="#readelf2">03-04) readelf查看2进制目标文件</a></li>
<li><a class="reference internal" href="#objdump-2">03-05) objdump显示（反汇编）2进制目标文件</a></li>
<li><a class="reference internal" href="#nm2">03-06) nm显示2进制目标文件的链接信息</a></li>
<li><a class="reference internal" href="#strace">03-07) strace动态跟踪程序运行时的系统调用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-by-step-learn-assembly-chapter4">04) 汇编语言中的寻址方式(step by step learn assembly: chapter4)</a></li>
<li><a class="reference internal" href="#id3">05)</a></li>
<li><a class="reference internal" href="#id4">06)</a></li>
<li><a class="reference internal" href="#id5">07)</a></li>
<li><a class="reference internal" href="#linuxc">08) 在LinuxC中嵌入汇编语言</a></li>
<li><a class="reference internal" href="#id6">09)</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tmux_tmuxp.html"
                        title="previous chapter">tmux和tmuxp的学习笔记</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="example.html"
                        title="next chapter">example of rst/这是关于rst的学习实例</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/assembly.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="example.html" title="example of rst/这是关于rst的学习实例"
             >next</a> |</li>
        <li class="right" >
          <a href="tmux_tmuxp.html" title="tmux和tmuxp的学习笔记"
             >previous</a> |</li>
        <li><a href="index.html">sphinx01 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, chengl6500.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>